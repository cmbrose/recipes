/* Track and surface recently viewed recipes — GPL‑0 (public domain) */
(function () {
    const KEY = 'recent_recipes_v1';
    const MAX = 20;                 // keep last 20 visits

    /* ---- helper: slug & title for current recipe page ---- */
    function currentEntry() {
        if (!document.body.dataset.recipeSlug) return null;   // not on a recipe page
        return {
            slug: document.body.dataset.recipeSlug,            // “/recipes/pesto‑peach‑chicken/”
            title: document.body.dataset.recipeTitle,           // pretty name
            ts: Date.now()
        };
    }

    /* ---- on recipe pages: push to localStorage ---- */
    const entry = currentEntry();
    if (entry) {
        const list = JSON.parse(localStorage.getItem(KEY) || '[]')
            .filter(e => e.slug !== entry.slug);
        list.unshift(entry);
        localStorage.setItem(KEY, JSON.stringify(list.slice(0, MAX)));
    }

    /* ---- on the index page: move recents to the top ---- */
    if (document.getElementById('recipe‑index')) {
        const list = JSON.parse(localStorage.getItem(KEY) || '[]');
        if (!list.length) return;

        const ul = document.getElementById('recipe‑index'); // <ul> generated by Liquid
        const lookup = new Map(list.map(e => [e.slug, e]));

        // find matching <li><a href="…"></a></li> nodes
        [...ul.children]
            .filter(li => lookup.has(li.querySelector('a').getAttribute('href')))
            .sort((a, b) => lookup.get(b.querySelector('a').href).ts -
                lookup.get(a.querySelector('a').href).ts)
            .forEach(li => ul.prepend(li));       // move most recent to top
    }
})();